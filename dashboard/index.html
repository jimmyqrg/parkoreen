<!DOCTYPE html>
<!-- VERSION: 2026-01-30-v7 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Parkoreen Dashboard - Manage your parkour maps">
    <title>Dashboard - Parkoreen</title>
    <link rel="manifest" href="/parkoreen/manifest.json">
    <meta name="theme-color" content="#2d5a27">
    <link rel="icon" type="image/png" sizes="32x32" href="/parkoreen/assets/png/icons/icon-dashboard-32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/parkoreen/assets/png/icons/icon-dashboard-64.png">
    <link rel="apple-touch-icon" href="/parkoreen/assets/png/icons/icon-dashboard-128.png">
    <link rel="stylesheet" href="/parkoreen/assets/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="page-header-left">
                <button class="btn btn-secondary" id="btn-join">
                    <span class="material-symbols-outlined">play_arrow</span>
                    Join
                </button>
            </div>
            <h1 class="page-title">Parkoreen</h1>
            <div class="page-header-right">
                <button class="btn btn-secondary" id="btn-settings">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </button>
                <button class="btn btn-primary" id="btn-new-map">
                    <span class="material-symbols-outlined">add_box</span>
                    New Map
                </button>
            </div>
        </header>

        <main class="page-content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <div class="card hidden" id="empty-state" style="text-align: center; padding: 48px;">
                <span class="material-symbols-outlined" style="font-size: 64px; color: var(--text-muted); margin-bottom: 16px;">map</span>
                <h3 style="margin-bottom: 8px;">No Maps Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Create your first parkour map to get started!</p>
                <button class="btn btn-primary" id="btn-create-first">
                    <span class="material-symbols-outlined">add</span>
                    Create Your First Map
                </button>
            </div>

            <div class="map-grid hidden" id="map-grid"></div>
        </main>
    </div>

    <script>
        // Inline toast fallback (no browser alerts)
        function showInlineToast(msg, type) {
            var existing = document.getElementById('inline-toast');
            if (existing) existing.remove();
            
            var toast = document.createElement('div');
            toast.id = 'inline-toast';
            toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;color:#fff;font-weight:500;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:90%;text-align:center;';
            toast.style.background = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : type === 'warning' ? '#f39c12' : '#3498db';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(function() { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, 3000);
            setTimeout(function() { if (toast.parentNode) toast.remove(); }, 3500);
        }
        
        // Inline modal fallback (no browser alerts/prompts)
        function showInlineModal(title, text, type) {
            return new Promise(function(resolve) {
                var overlay = document.createElement('div');
                overlay.id = 'inline-modal-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:99998;display:flex;align-items:center;justify-content:center;';
                
                var modal = document.createElement('div');
                modal.style.cssText = 'background:#1a1a2e;padding:24px;border-radius:12px;max-width:400px;width:90%;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.3);';
                
                var titleEl = document.createElement('h3');
                titleEl.style.cssText = 'margin:0 0 12px 0;font-size:1.25rem;';
                titleEl.textContent = title;
                modal.appendChild(titleEl);
                
                var textEl = document.createElement('p');
                textEl.style.cssText = 'margin:0 0 20px 0;color:#b8b8b8;';
                textEl.textContent = text;
                modal.appendChild(textEl);
                
                var input = null;
                if (type === 'prompt') {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.style.cssText = 'width:100%;padding:10px;border:1px solid #353555;border-radius:6px;background:#252540;color:#fff;margin-bottom:16px;box-sizing:border-box;';
                    input.placeholder = text;
                    modal.appendChild(input);
                }
                
                var btnContainer = document.createElement('div');
                btnContainer.style.cssText = 'display:flex;gap:12px;justify-content:flex-end;';
                
                if (type === 'confirm' || type === 'prompt') {
                    var cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.style.cssText = 'padding:10px 20px;border:none;border-radius:6px;cursor:pointer;background:#353555;color:#fff;';
                    cancelBtn.onclick = function() { overlay.remove(); resolve(type === 'prompt' ? null : false); };
                    btnContainer.appendChild(cancelBtn);
                }
                
                var okBtn = document.createElement('button');
                okBtn.textContent = type === 'confirm' ? 'Confirm' : 'OK';
                okBtn.style.cssText = 'padding:10px 20px;border:none;border-radius:6px;cursor:pointer;background:#2d5a27;color:#fff;';
                okBtn.onclick = function() { overlay.remove(); resolve(type === 'prompt' ? (input ? input.value : '') : true); };
                btnContainer.appendChild(okBtn);
                
                modal.appendChild(btnContainer);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                if (input) input.focus();
            });
        }
        
        // Safe toast functions
        function showToast(msg, type) {
            console.log('[Toast ' + type + ']', msg);
            try {
                if (window.ToastManager && typeof window.ToastManager.show === 'function') {
                    window.ToastManager.show(msg, type);
                } else { showInlineToast(msg, type); }
            } catch (e) { showInlineToast(msg, type); }
        }
        function toastSuccess(msg) { showToast(msg, 'success'); }
        function toastError(msg) { showToast(msg, 'error'); }
        function toastWarning(msg) { showToast(msg, 'warning'); }
        function toastInfo(msg) { showToast(msg, 'info'); }
        
        // Safe modal functions
        function modalConfirm(title, text) {
            try {
                if (window.ModalManager && typeof window.ModalManager.confirm === 'function') {
                    return window.ModalManager.confirm(title, text);
                }
            } catch (e) { console.error('Modal error:', e); }
            return showInlineModal(title, text, 'confirm');
        }
        function modalPrompt(title, placeholder) {
            try {
                if (window.ModalManager && typeof window.ModalManager.prompt === 'function') {
                    return window.ModalManager.prompt(title, placeholder);
                }
            } catch (e) { console.error('Modal error:', e); }
            return showInlineModal(title, placeholder || '', 'prompt');
        }
    </script>

    <script src="/parkoreen/runtime.js?v=19"></script>
    <script src="/parkoreen/assets/js/style.js?v=11"></script>
    
    <script>
        console.log('[Dashboard] Version: v7');
        console.log('[Debug] Auth:', window.Auth);
        console.log('[Debug] Auth.isLoggedIn:', window.Auth ? window.Auth.isLoggedIn() : 'N/A');
        console.log('[Debug] MapManager:', window.MapManager);
        console.log('[Debug] MapManager type:', typeof window.MapManager);
        console.log('[Debug] MapManager.listMaps:', window.MapManager ? window.MapManager.listMaps : 'N/A');
        console.log('[Debug] MapManager.listMaps type:', window.MapManager ? typeof window.MapManager.listMaps : 'N/A');
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/parkoreen/sw.js')
                .then(function() { console.log('SW registered'); })
                .catch(function(e) { console.log('SW failed:', e); });
        }
    </script>
    
    <script>
        var loading = document.getElementById('loading');
        var emptyState = document.getElementById('empty-state');
        var mapGrid = document.getElementById('map-grid');

        document.addEventListener('DOMContentLoaded', async function() {
            if (!Auth.requireAuth()) return;
            await loadMaps();

            document.getElementById('btn-join').onclick = function() { window.open('/parkoreen/join.html', '_blank'); };
            document.getElementById('btn-settings').onclick = function() { Navigation.toSettings(); };
            document.getElementById('btn-new-map').onclick = createNewMap;
            document.getElementById('btn-create-first').onclick = createNewMap;
        });

        async function loadMaps() {
            try {
                // Use .call() to ensure proper binding
                var listFn = window.MapManager.listMaps;
                var maps = await listFn.call(window.MapManager);
                
                // Hide loading
                loading.classList.add('hidden');
                
                // Reset both states first
                emptyState.classList.add('hidden');
                mapGrid.classList.add('hidden');
                mapGrid.innerHTML = '';

                if (maps.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    mapGrid.classList.remove('hidden');
                    renderMaps(maps);
                }
            } catch (e) {
                loading.classList.add('hidden');
                toastError('Failed to load maps: ' + e.message);
            }
        }

        function renderMaps(maps) {
            mapGrid.innerHTML = '';
            maps.forEach(function(map) {
                var card = document.createElement('div');
                card.className = 'map-card';
                card.innerHTML = 
                    '<div class="map-card-preview"><span class="material-symbols-outlined" style="font-size: 48px;">terrain</span></div>' +
                    '<div class="map-card-body">' +
                        '<h3 class="map-card-title" data-map-id="' + map.id + '" style="cursor: pointer;" title="Click to rename">' + escapeHtml(map.name) + '</h3>' +
                        '<div class="map-card-actions">' +
                            '<button class="btn btn-secondary btn-host"><span class="material-symbols-outlined">home_and_garden</span>Host</button>' +
                            '<button class="btn btn-secondary btn-edit"><span class="material-symbols-outlined">edit_square</span>Edit</button>' +
                            '<button class="btn btn-secondary btn-duplicate" title="Duplicate"><span class="material-symbols-outlined">content_copy</span></button>' +
                            '<button class="btn btn-danger btn-delete"><span class="material-symbols-outlined">delete_forever</span></button>' +
                        '</div>' +
                    '</div>';
                card.querySelector('.map-card-title').onclick = function() { renameMap(map.id, map.name); };
                card.querySelector('.btn-host').onclick = function() { hostMap(map.id); };
                card.querySelector('.btn-edit').onclick = function() { editMap(map.id); };
                card.querySelector('.btn-duplicate').onclick = function() { duplicateMap(map.id, map.name); };
                card.querySelector('.btn-delete').onclick = function() { deleteMap(map.id, map.name); };
                mapGrid.appendChild(card);
            });
        }

        async function createNewMap() {
            // Show popup with Import/Create options
            var choice = await showNewMapPopup();
            if (!choice) return;

            if (choice === 'import') {
                // Trigger file input for import
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pkrn';
                input.onchange = async function(e) {
                    var file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        var text = await file.text();
                        var data = JSON.parse(text);
                        var name = data.mapName || file.name.replace('.pkrn', '');
                        
                        var createFn = window.MapManager.createMap;
                        var result = await createFn.call(window.MapManager, name);
                        
                        // Save the imported data
                        var saveFn = window.MapManager.saveMap;
                        await saveFn.call(window.MapManager, result.id, { data: data });
                        
                        toastSuccess('Map imported!');
                        window.open('/parkoreen/host.html?map=' + result.id, '_blank');
                        await loadMaps();
                    } catch (err) {
                        toastError('Failed to import: ' + err.message);
                    }
                };
                input.click();
            } else if (choice === 'create') {
                var name = await modalPrompt('New Map', 'Enter map name');
                if (!name || !name.trim()) return;

                try {
                    var createFn = window.MapManager.createMap;
                    var result = await createFn.call(window.MapManager, name.trim());
                    toastSuccess('Map created!');
                    window.open('/parkoreen/host.html?map=' + result.id, '_blank');
                } catch (e) {
                    toastError('Failed to create map: ' + e.message);
                }
            }
        }

        function showNewMapPopup() {
            return new Promise(function(resolve) {
                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:99998;display:flex;align-items:center;justify-content:center;';
                
                var modal = document.createElement('div');
                modal.style.cssText = 'background:#1a1a2e;padding:24px;border-radius:12px;max-width:300px;width:90%;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.3);';
                
                modal.innerHTML = 
                    '<h3 style="margin:0 0 20px 0;text-align:center;">New Map</h3>' +
                    '<div style="display:flex;flex-direction:column;gap:12px;">' +
                        '<button class="btn btn-primary" id="popup-create" style="width:100%;padding:16px;">' +
                            '<span class="material-symbols-outlined" style="vertical-align:middle;margin-right:8px;">add</span>' +
                            'Create Map' +
                        '</button>' +
                        '<button class="btn btn-secondary" id="popup-import" style="width:100%;padding:16px;">' +
                            '<span class="material-symbols-outlined" style="vertical-align:middle;margin-right:8px;">upload</span>' +
                            'Import Map (.pkrn)' +
                        '</button>' +
                        '<button class="btn btn-ghost" id="popup-cancel" style="width:100%;margin-top:8px;">Cancel</button>' +
                    '</div>';
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                modal.querySelector('#popup-create').onclick = function() {
                    document.body.removeChild(overlay);
                    resolve('create');
                };
                modal.querySelector('#popup-import').onclick = function() {
                    document.body.removeChild(overlay);
                    resolve('import');
                };
                modal.querySelector('#popup-cancel').onclick = function() {
                    document.body.removeChild(overlay);
                    resolve(null);
                };
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                        resolve(null);
                    }
                };
            });
        }

        async function renameMap(id, currentName) {
            var newName = await modalPrompt('Rename Map', 'Enter new name for "' + currentName + '"');
            if (!newName || !newName.trim() || newName.trim() === currentName) return;

            try {
                // Get the map, update name, save
                var getFn = window.MapManager.getMap;
                var mapData = await getFn.call(window.MapManager, id);
                
                var saveFn = window.MapManager.saveMap;
                await saveFn.call(window.MapManager, id, { 
                    name: newName.trim(),
                    data: mapData.data 
                });
                
                toastSuccess('Map renamed!');
                await loadMaps();
            } catch (e) {
                toastError('Failed to rename: ' + e.message);
            }
        }

        function hostMap(id) {
            window.open('/parkoreen/host.html?map=' + id + '&mode=host', '_blank');
        }

        function editMap(id) {
            window.open('/parkoreen/host.html?map=' + id, '_blank');
        }

        async function duplicateMap(id, name) {
            try {
                var duplicateFn = window.MapManager.duplicateMap;
                var result = await duplicateFn.call(window.MapManager, id);
                toastSuccess('Map duplicated as "' + result.name + '"!');
                await loadMaps();
            } catch (e) {
                toastError('Failed to duplicate: ' + e.message);
            }
        }

        async function deleteMap(id, name) {
            var confirmed = await modalConfirm('Delete', 'Are you sure you want to delete this map?');
            if (!confirmed) return;

            var confirmName = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            var typed = prompt('Enter "' + confirmName + '" to confirm:');
            
            if (typed === confirmName) {
                try {
                    var deleteFn = window.MapManager.deleteMap;
                    await deleteFn.call(window.MapManager, id);
                    toastSuccess('Map deleted!');
                    await loadMaps();
                } catch (e) {
                    toastError('Failed to delete: ' + e.message);
                }
            } else if (typed !== null) {
                toastError('Name did not match.');
            }
        }

        function escapeHtml(text) {
            var d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    </script>
</body>
</html>
