<!DOCTYPE html>
<!-- VERSION: 2026-01-30-v6 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Parkoreen Dashboard - Manage your parkour maps">
    <title>Dashboard - Parkoreen</title>
    <link rel="manifest" href="/parkoreen/manifest.json">
    <meta name="theme-color" content="#2d5a27">
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="/parkoreen/assets/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="page-container">
        <header class="page-header">
            <div class="page-header-left">
                <button class="btn btn-secondary" id="btn-join">
                    <span class="material-symbols-outlined">play_arrow</span>
                    Join
                </button>
            </div>
            <h1 class="page-title">Parkoreen</h1>
            <div class="page-header-right">
                <button class="btn btn-secondary" id="btn-settings">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </button>
                <button class="btn btn-primary" id="btn-new-map">
                    <span class="material-symbols-outlined">add_box</span>
                    New Map
                </button>
            </div>
        </header>

        <main class="page-content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <div class="card hidden" id="empty-state" style="text-align: center; padding: 48px;">
                <span class="material-symbols-outlined" style="font-size: 64px; color: var(--text-muted); margin-bottom: 16px;">map</span>
                <h3 style="margin-bottom: 8px;">No Maps Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Create your first parkour map to get started!</p>
                <button class="btn btn-primary" id="btn-create-first">
                    <span class="material-symbols-outlined">add</span>
                    Create Your First Map
                </button>
            </div>

            <div class="map-grid hidden" id="map-grid"></div>
        </main>
    </div>

    <script>
        // Safe toast functions that ALWAYS work
        function showToast(msg, type) {
            console.log('[Toast ' + type + ']', msg);
            try {
                if (window.ToastManager && typeof window.ToastManager.show === 'function') {
                    window.ToastManager.show(msg, type);
                } else {
                    alert(msg);
                }
            } catch (e) {
                console.error('Toast error:', e);
                alert(msg);
            }
        }
        function toastSuccess(msg) { showToast(msg, 'success'); }
        function toastError(msg) { showToast(msg, 'error'); }
        function toastWarning(msg) { showToast(msg, 'warning'); }
        function toastInfo(msg) { showToast(msg, 'info'); }
        
        // Safe modal functions
        function modalConfirm(title, text) {
            try {
                if (window.ModalManager && typeof window.ModalManager.confirm === 'function') {
                    return window.ModalManager.confirm(title, text);
                }
            } catch (e) { console.error('Modal error:', e); }
            return Promise.resolve(confirm(text || title));
        }
        function modalPrompt(title, placeholder) {
            try {
                if (window.ModalManager && typeof window.ModalManager.prompt === 'function') {
                    return window.ModalManager.prompt(title, placeholder);
                }
            } catch (e) { console.error('Modal error:', e); }
            return Promise.resolve(prompt(title, placeholder || ''));
        }
    </script>

    <script src="/parkoreen/runtime.js?v=6"></script>
    <script src="/parkoreen/assets/js/style.js?v=6"></script>
    
    <script>
        console.log('[Dashboard] Version: v6');
        console.log('[Debug] Auth:', window.Auth);
        console.log('[Debug] Auth.isLoggedIn:', window.Auth ? window.Auth.isLoggedIn() : 'N/A');
        console.log('[Debug] MapManager:', window.MapManager);
        console.log('[Debug] MapManager type:', typeof window.MapManager);
        console.log('[Debug] MapManager.listMaps:', window.MapManager ? window.MapManager.listMaps : 'N/A');
        console.log('[Debug] MapManager.listMaps type:', window.MapManager ? typeof window.MapManager.listMaps : 'N/A');
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/parkoreen/sw.js')
                .then(function() { console.log('SW registered'); })
                .catch(function(e) { console.log('SW failed:', e); });
        }
    </script>
    
    <script>
        var loading = document.getElementById('loading');
        var emptyState = document.getElementById('empty-state');
        var mapGrid = document.getElementById('map-grid');

        document.addEventListener('DOMContentLoaded', async function() {
            if (!Auth.requireAuth()) return;
            await loadMaps();

            document.getElementById('btn-join').onclick = function() { Navigation.toJoin(); };
            document.getElementById('btn-settings').onclick = function() { Navigation.toSettings(); };
            document.getElementById('btn-new-map').onclick = createNewMap;
            document.getElementById('btn-create-first').onclick = createNewMap;
        });

        async function loadMaps() {
            try {
                // Use .call() to ensure proper binding
                var listFn = window.MapManager.listMaps;
                var maps = await listFn.call(window.MapManager);
                loading.classList.add('hidden');

                if (maps.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    mapGrid.classList.remove('hidden');
                    renderMaps(maps);
                }
            } catch (e) {
                loading.classList.add('hidden');
                toastError('Failed to load maps: ' + e.message);
            }
        }

        function renderMaps(maps) {
            mapGrid.innerHTML = '';
            maps.forEach(function(map) {
                var card = document.createElement('div');
                card.className = 'map-card';
                card.innerHTML = 
                    '<div class="map-card-preview"><span class="material-symbols-outlined" style="font-size: 48px;">terrain</span></div>' +
                    '<div class="map-card-body">' +
                        '<h3 class="map-card-title">' + escapeHtml(map.name) + '</h3>' +
                        '<div class="map-card-actions">' +
                            '<button class="btn btn-secondary btn-host"><span class="material-symbols-outlined">home_and_garden</span>Host</button>' +
                            '<button class="btn btn-secondary btn-edit"><span class="material-symbols-outlined">edit_square</span>Edit</button>' +
                            '<button class="btn btn-danger btn-delete"><span class="material-symbols-outlined">delete_forever</span></button>' +
                        '</div>' +
                    '</div>';
                card.querySelector('.btn-host').onclick = function() { hostMap(map.id); };
                card.querySelector('.btn-edit').onclick = function() { editMap(map.id); };
                card.querySelector('.btn-delete').onclick = function() { deleteMap(map.id, map.name); };
                mapGrid.appendChild(card);
            });
        }

        async function createNewMap() {
            var name = await modalPrompt('New Map', 'Enter map name');
            if (!name || !name.trim()) return;

            try {
                var createFn = window.MapManager.createMap;
                var result = await createFn.call(window.MapManager, name.trim());
                toastSuccess('Map created!');
                window.location.href = '/parkoreen/host.html?map=' + result.id;
            } catch (e) {
                toastError('Failed to create map: ' + e.message);
            }
        }

        function hostMap(id) {
            window.location.href = '/parkoreen/host.html?map=' + id + '&mode=host';
        }

        function editMap(id) {
            window.location.href = '/parkoreen/host.html?map=' + id;
        }

        async function deleteMap(id, name) {
            var confirmed = await modalConfirm('Delete', 'Are you sure you want to delete this map?');
            if (!confirmed) return;

            var confirmName = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            var typed = prompt('Enter "' + confirmName + '" to confirm:');
            
            if (typed === confirmName) {
                try {
                    var deleteFn = window.MapManager.deleteMap;
                    await deleteFn.call(window.MapManager, id);
                    toastSuccess('Map deleted!');
                    await loadMaps();
                } catch (e) {
                    toastError('Failed to delete: ' + e.message);
                }
            } else if (typed !== null) {
                toastError('Name did not match.');
            }
        }

        function escapeHtml(text) {
            var d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    </script>
</body>
</html>
