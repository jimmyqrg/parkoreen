<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Parkoreen Dashboard - Manage your parkour maps">
    <title>Dashboard - Parkoreen</title>
    <link rel="manifest" href="/parkoreen/manifest.json">
    <meta name="theme-color" content="#2d5a27">
    <link rel="stylesheet" href="/parkoreen/assets/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="page-header-left">
                <button class="btn btn-secondary" id="btn-join">
                    <span class="material-symbols-outlined">play_arrow</span>
                    Join
                </button>
            </div>
            <h1 class="page-title">Parkoreen</h1>
            <div class="page-header-right">
                <button class="btn btn-secondary" id="btn-settings">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </button>
                <button class="btn btn-primary" id="btn-new-map">
                    <span class="material-symbols-outlined">add_box</span>
                    New Map
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="page-content">
            <!-- Loading state -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <!-- Empty state -->
            <div class="card hidden" id="empty-state" style="text-align: center; padding: 48px;">
                <span class="material-symbols-outlined" style="font-size: 64px; color: var(--text-muted); margin-bottom: 16px;">map</span>
                <h3 style="margin-bottom: 8px;">No Maps Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Create your first parkour map to get started!</p>
                <button class="btn btn-primary" id="btn-create-first">
                    <span class="material-symbols-outlined">add</span>
                    Create Your First Map
                </button>
            </div>

            <!-- Map grid -->
            <div class="map-grid hidden" id="map-grid">
                <!-- Maps will be dynamically inserted here -->
            </div>
        </main>

        <!-- Footer will be added by runtime.js -->
    </div>

    <!-- Define fallbacks FIRST before loading any scripts -->
    <script>
        // Minimal fallbacks - will be overwritten by style.js if it loads successfully
        window.ToastManager = {
            show: function(msg, type) { console.log('[Toast]', type, msg); alert(msg); },
            success: function(msg) { console.log('[Toast] success:', msg); alert('✓ ' + msg); },
            error: function(msg) { console.log('[Toast] error:', msg); alert('✗ ' + msg); },
            warning: function(msg) { console.log('[Toast] warning:', msg); alert('⚠ ' + msg); },
            info: function(msg) { console.log('[Toast] info:', msg); alert('ℹ ' + msg); }
        };
        window.ModalManager = {
            show: function(opts) { return Promise.resolve(confirm(opts.text || opts.title || 'Confirm?')); },
            confirm: function(title, text) { return Promise.resolve(confirm(text || title)); },
            alert: function(title, text) { alert(text || title); return Promise.resolve(); },
            prompt: function(title, placeholder) { return Promise.resolve(prompt(title, placeholder || '')); }
        };
        window.LoadingManager = {
            show: function() {},
            hide: function() {},
            update: function() {}
        };
        window.AnimationUtils = { shake: function() {} };
    </script>

    <!-- Scripts -->
    <script src="/parkoreen/runtime.js"></script>
    <script src="/parkoreen/assets/js/style.js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/parkoreen/sw.js')
                .then(function(reg) { console.log('SW registered'); })
                .catch(function(err) { console.log('SW registration failed:', err); });
        }
    </script>
    <script>
        // DOM Elements
        var loading = document.getElementById('loading');
        var emptyState = document.getElementById('empty-state');
        var mapGrid = document.getElementById('map-grid');

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Check auth
            if (!Auth.requireAuth()) return;

            // Load maps
            await loadMaps();

            // Event listeners
            document.getElementById('btn-join').addEventListener('click', function() {
                Navigation.toJoin();
            });

            document.getElementById('btn-settings').addEventListener('click', function() {
                Navigation.toSettings();
            });

            document.getElementById('btn-new-map').addEventListener('click', createNewMap);
            document.getElementById('btn-create-first').addEventListener('click', createNewMap);
        });

        async function loadMaps() {
            try {
                var maps = await MapManager.listMaps();
                
                loading.classList.add('hidden');

                if (maps.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    mapGrid.classList.remove('hidden');
                    renderMaps(maps);
                }
            } catch (error) {
                loading.classList.add('hidden');
                ToastManager.error('Failed to load maps: ' + error.message);
            }
        }

        function renderMaps(maps) {
            mapGrid.innerHTML = '';

            maps.forEach(function(map) {
                var card = document.createElement('div');
                card.className = 'map-card';
                card.innerHTML = 
                    '<div class="map-card-preview">' +
                        '<span class="material-symbols-outlined" style="font-size: 48px;">terrain</span>' +
                    '</div>' +
                    '<div class="map-card-body">' +
                        '<h3 class="map-card-title">' + escapeHtml(map.name) + '</h3>' +
                        '<div class="map-card-actions">' +
                            '<button class="btn btn-secondary" data-action="host" data-id="' + map.id + '">' +
                                '<span class="material-symbols-outlined">home_and_garden</span>' +
                                'Host' +
                            '</button>' +
                            '<button class="btn btn-secondary" data-action="edit" data-id="' + map.id + '">' +
                                '<span class="material-symbols-outlined">edit_square</span>' +
                                'Edit' +
                            '</button>' +
                            '<button class="btn btn-danger" data-action="delete" data-id="' + map.id + '" data-name="' + escapeHtml(map.name) + '">' +
                                '<span class="material-symbols-outlined">delete_forever</span>' +
                            '</button>' +
                        '</div>' +
                    '</div>';

                // Event listeners
                card.querySelector('[data-action="host"]').addEventListener('click', function() { hostMap(map.id); });
                card.querySelector('[data-action="edit"]').addEventListener('click', function() { editMap(map.id); });
                card.querySelector('[data-action="delete"]').addEventListener('click', function() { deleteMap(map.id, map.name); });

                mapGrid.appendChild(card);
            });
        }

        async function createNewMap() {
            var name = await ModalManager.prompt('New Map', 'Enter map name');
            
            if (!name || !name.trim()) return;

            try {
                LoadingManager.show('Creating map...');
                var result = await MapManager.createMap(name.trim());
                LoadingManager.hide();
                
                ToastManager.success('Map created!');
                window.location.href = '/parkoreen/host.html?map=' + result.id;
            } catch (error) {
                LoadingManager.hide();
                ToastManager.error('Failed to create map: ' + error.message);
            }
        }

        function hostMap(mapId) {
            window.location.href = '/parkoreen/host.html?map=' + mapId + '&mode=host';
        }

        function editMap(mapId) {
            window.location.href = '/parkoreen/host.html?map=' + mapId;
        }

        async function deleteMap(mapId, mapName) {
            // First confirmation
            var confirmed = await ModalManager.confirm(
                'Delete Confirmation',
                'Are you sure you want to delete this map?'
            );

            if (!confirmed) return;

            // Second confirmation
            var confirmName = mapName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            var typedName = prompt('Enter "' + confirmName + '" to confirm deletion:');
            
            if (typedName === confirmName) {
                try {
                    LoadingManager.show('Deleting map...');
                    await MapManager.deleteMap(mapId);
                    LoadingManager.hide();
                    
                    ToastManager.success('Map deleted!');
                    await loadMaps();
                } catch (error) {
                    LoadingManager.hide();
                    ToastManager.error('Failed to delete map: ' + error.message);
                }
            } else if (typedName !== null) {
                ToastManager.error('Name did not match. Deletion cancelled.');
            }
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
