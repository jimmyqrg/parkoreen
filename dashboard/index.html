<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Parkoreen Dashboard - Manage your parkour maps">
    <title>Dashboard - Parkoreen</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2d5a27">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="page-header-left">
                <button class="btn btn-secondary" id="btn-join">
                    <span class="material-symbols-outlined">play_arrow</span>
                    Join
                </button>
            </div>
            <h1 class="page-title">Parkoreen</h1>
            <div class="page-header-right">
                <button class="btn btn-secondary" id="btn-settings">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </button>
                <button class="btn btn-primary" id="btn-new-map">
                    <span class="material-symbols-outlined">add_box</span>
                    New Map
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="page-content">
            <!-- Loading state -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <!-- Empty state -->
            <div class="card hidden" id="empty-state" style="text-align: center; padding: 48px;">
                <span class="material-symbols-outlined" style="font-size: 64px; color: var(--text-muted); margin-bottom: 16px;">map</span>
                <h3 style="margin-bottom: 8px;">No Maps Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Create your first parkour map to get started!</p>
                <button class="btn btn-primary" id="btn-create-first">
                    <span class="material-symbols-outlined">add</span>
                    Create Your First Map
                </button>
            </div>

            <!-- Map grid -->
            <div class="map-grid hidden" id="map-grid">
                <!-- Maps will be dynamically inserted here -->
            </div>
        </main>

        <!-- Footer will be added by runtime.js -->
    </div>

    <!-- Scripts -->
    <script src="/runtime.js"></script>
    <script src="/assets/js/style.js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>
    <script>
        // DOM Elements
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const mapGrid = document.getElementById('map-grid');

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check auth
            if (!Auth.requireAuth()) return;

            // Load maps
            await loadMaps();

            // Event listeners
            document.getElementById('btn-join').addEventListener('click', () => {
                Navigation.toJoin();
            });

            document.getElementById('btn-settings').addEventListener('click', () => {
                Navigation.toSettings();
            });

            document.getElementById('btn-new-map').addEventListener('click', createNewMap);
            document.getElementById('btn-create-first').addEventListener('click', createNewMap);
        });

        async function loadMaps() {
            try {
                const maps = await MapManager.listMaps();
                
                loading.classList.add('hidden');

                if (maps.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    mapGrid.classList.remove('hidden');
                    renderMaps(maps);
                }
            } catch (error) {
                loading.classList.add('hidden');
                ToastManager.error('Failed to load maps: ' + error.message);
            }
        }

        function renderMaps(maps) {
            mapGrid.innerHTML = '';

            maps.forEach(map => {
                const card = document.createElement('div');
                card.className = 'map-card';
                card.innerHTML = `
                    <div class="map-card-preview">
                        <span class="material-symbols-outlined" style="font-size: 48px;">terrain</span>
                    </div>
                    <div class="map-card-body">
                        <h3 class="map-card-title">${escapeHtml(map.name)}</h3>
                        <div class="map-card-actions">
                            <button class="btn btn-secondary" data-action="host" data-id="${map.id}">
                                <span class="material-symbols-outlined">home_and_garden</span>
                                Host
                            </button>
                            <button class="btn btn-secondary" data-action="edit" data-id="${map.id}">
                                <span class="material-symbols-outlined">edit_square</span>
                                Edit
                            </button>
                            <button class="btn btn-danger" data-action="delete" data-id="${map.id}" data-name="${escapeHtml(map.name)}">
                                <span class="material-symbols-outlined">delete_forever</span>
                            </button>
                        </div>
                    </div>
                `;

                // Event listeners
                card.querySelector('[data-action="host"]').addEventListener('click', () => hostMap(map.id));
                card.querySelector('[data-action="edit"]').addEventListener('click', () => editMap(map.id));
                card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteMap(map.id, map.name));

                mapGrid.appendChild(card);
            });
        }

        async function createNewMap() {
            const name = await ModalManager.prompt('New Map', 'Enter map name');
            
            if (!name || !name.trim()) return;

            try {
                LoadingManager.show('Creating map...');
                const result = await MapManager.createMap(name.trim());
                LoadingManager.hide();
                
                ToastManager.success('Map created!');
                Navigation.toEditor(result.id);
            } catch (error) {
                LoadingManager.hide();
                ToastManager.error('Failed to create map: ' + error.message);
            }
        }

        function hostMap(mapId) {
            window.location.href = `/host.html?map=${mapId}&mode=host`;
        }

        function editMap(mapId) {
            Navigation.toEditor(mapId);
        }

        async function deleteMap(mapId, mapName) {
            // First confirmation
            const confirmed = await ModalManager.confirm(
                'Delete Confirmation',
                'Are you sure you want to delete this map?'
            );

            if (!confirmed) return;

            // Second confirmation with name typing
            const confirmName = mapName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            const result = await ModalManager.show({
                title: 'Delete Confirmation',
                html: `
                    <p style="color: var(--text-secondary); margin-bottom: 16px; text-align: center;">
                        Enter <strong style="color: var(--accent);">${confirmName}</strong> to confirm
                    </p>
                    <input type="text" class="form-input" id="delete-confirm-input" placeholder="Type to confirm">
                `,
                buttons: [
                    { text: 'Confirm', value: 'confirm', danger: true },
                    { text: 'Cancel', value: 'cancel' }
                ]
            });

            if (result === 'confirm') {
                const input = document.getElementById('delete-confirm-input');
                if (input && input.value === confirmName) {
                    try {
                        LoadingManager.show('Deleting map...');
                        await MapManager.deleteMap(mapId);
                        LoadingManager.hide();
                        
                        ToastManager.success('Map deleted!');
                        await loadMaps();
                    } catch (error) {
                        LoadingManager.hide();
                        ToastManager.error('Failed to delete map: ' + error.message);
                    }
                } else {
                    ToastManager.error('Name did not match. Deletion cancelled.');
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
